<template>
  <div class="network-config">
    <div class="d-flex align-items-start mb-2" v-for="(item, i) in networkList" :key="item.key">
      <a-tag color="blue" class="mr-1" style="margin-top: 10px;">{{ isBonding ? 'bond' : '网卡'}}{{i + count}}</a-tag>
      <a-form-item
        :wrapperCol="{ span: 24 }"
        style="min-width: 200px;"
        class="w-25 mb-0 mr-1">
        <base-select
          v-if="i === 0"
          class="w-100"
          v-decorator="decorator.vpcs(item.key)"
          :resource="vpcResource"
          remote
          :label-format="vpcLabelFormat"
          :item.sync="item.vpc"
          :need-params="true"
          :params="vpcParams"
          :mapper="vpcResourceMapper"
          :select-props="{ allowClear: true, placeholder: '请选择VPC', disabled: vpcObj && !!vpcObj.id }" />
        <a-tag v-else color="blue" class="w-100 mr-1">{{ getVpcTag(networkList[0].vpc) }}</a-tag>
      </a-form-item>
      <a-form-item
        :wrapperCol="{ span: 24 }"
        style="min-width: 200px;"
        class="w-25 mb-0 mr-1">
        <base-select
          class="w-100"
          v-decorator="decorator.networks(item.key)"
          resource="networks"
          remote
          show-sync
          :item.sync="item.network"
          :need-params="true"
          :params="{ ...networkParamsC, $t: item.key }"
          :mapper="networkResourceMapper"
          :select-props="{ allowClear: true, placeholder: '请选择IP子网' }" />
          <div slot="extra" v-if="i === 0">
            没有想要的？可以立即
            <help-link href="/network2"> 立即新建</help-link>
          </div>
      </a-form-item>
      <a-form-item class="mb-0 mr-2" v-if="item.ipShow" :wrapperCol="{ span: 24 }">
        <a-input
          placeholder="请输入子网内的IP地址"
          @change="e => ipChange(e, i)"
          v-decorator="decorator.ips(item.key, item.network)" />
      </a-form-item>
      <a-button v-else type="link" class="mr-1 mt-1" @click="showIp(item)">手动配置IP</a-button>
      <a-button shape="circle" icon="minus" size="small" v-if="i !== 0" @click="decrease(item.key, i)" class="mt-2" />
    </div>
    <div class="d-flex align-items-center" v-if="networkCountRemaining > 0">
      <a-button type="primary" shape="circle" icon="plus" size="small" @click="add" />
      <a-button type="link" @click="add">添加网卡</a-button>
      <span class="network-count-tips">您还可以添加 <span class="remain-num">{{ networkCountRemaining }}</span> 个</span>
    </div>
  </div>
</template>

<script>
import * as R from 'ramda'
import { uuid } from '@/utils/utils'

export default {
  name: 'NetworkConfig',
  props: {
    count: {
      type: Number,
      default: () => 0,
    },
    networkParams: {
      type: Object,
      required: true,
    },
    limit: {
      type: Number,
      default: 8, // 默认支持最多 8 个ip子网
    },
    form: {
      type: Object,
      required: true,
    },
    decorator: {
      type: Object,
      required: true,
      validator: val => R.is(Function, val.vpcs) && R.is(Function, val.networks) && R.is(Function, val.ips),
    },
    isBonding: {
      type: Boolean,
      default: false,
    },
    networkResourceMapper: {
      type: Function,
      default: (data) => { return data },
    },
    vpcParams: {
      type: Object,
      required: true,
    },
    vpcResource: {
      type: String,
      default: 'vpcs', // 还可能是这样的resource cloudregions/{region_id}/vpcs
    },
    vpcResourceMapper: {
      type: Function,
      default: data => { return data },
    },
    vpcObj: {
      type: Object,
      validator: val => val.id && val.name,
    },
  },
  data () {
    return {
      networkList: [],
    }
  },
  computed: {
    networkCountRemaining () {
      return this.limit - this.networkList.length
    },
    networkParamsC () {
      return {
        vpc: this.networkList[0].vpc.id,
        ...this.networkParams,
      }
    },
  },
  created () {
    this.add()
  },
  methods: {
    getVpcTag (data) {
      if (!data.cidr_block) return data.name
      return `${data.name}（${data.cidr_block}）`
    },
    vpcLabelFormat (item) {
      if (!item.cidr_block) return item.name
      return `${item.name}（${item.cidr_block}）`
    },
    ipChange (e, i) {
      this.networkList[i].ip = e.target.value
    },
    add () {
      const uid = uuid()
      const data = {
        network: {},
        vpc: {},
        ipShow: false,
        key: uid,
      }
      if (this.vpcObj) {
        data.vpc = this.vpcObj
      }
      this.networkList.push(data)
      this.$nextTick(() => {
        if (this.vpcObj) {
          this.form.fc.setFieldsValue({
            [this.decorator.vpcs(uid)[0]]: this.vpcObj.id,
          })
        }
      })
    },
    showIp (item, i) {
      item.ipShow = true
    },
    decrease (uid, index) {
      this.networkList.splice(index, 1)
    },
  },
}
</script>

<style lang="scss" scoped>
@import '../../../../src/styles/variables';

.network-config {
  .network-count-tips {
    .remain-num {
      color: $primary-color;
    }
  }
}
</style>
