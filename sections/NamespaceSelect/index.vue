<template>
  <a-select
    show-search
    :disabled="disabled"
    @change="change"
    placeholder="请选择命名空间"
    style="min-width: 200px;"
    :filter-option="filterOption"
    option-filter-prop="children"
    :value="value">
    <a-select-option v-for="item in options" :value="item.name" :key="item.name">
      <div class="d-flex">
        <span class="text-truncate flex-fill mr-2">{{ item.label || item.name }}</span>
        <span style="color: #8492a6; font-size: 13px" v-if="R.is(Number, item.num)">{{ item.num }}</span>
      </div>
    </a-select-option>
  </a-select>
</template>

<script>
import * as R from 'ramda'

export default {
  name: 'K8sComponentsNamespace',
  props: {
    value: { // String
    },
    supportAllNamespace: {
      type: Boolean,
      default: false,
    },
    setDefault: { // 设置默认
      type: Boolean,
      default: true,
    },
    cluster: {
      type: String,
    },
    disabled: {
      type: Boolean,
      default: false,
    },
    namespaceMap: {
      type: Object,
      default: () => ({}),
    },
  },
  data () {
    return {
      options: [],
      R,
    }
  },
  watch: {
    cluster (v) {
      if (v) this._fetchNamespace()
    },
    namespaceMap () {
      this.$nextTick(this.addNum)
    },
  },
  created () {
    this._fetchNamespace()
  },
  methods: {
    addNum () {
      if (R.isEmpty(this.namespaceMap)) return
      this.options = this.options.map(val => {
        const item = R.clone(val)
        if (R.is(Array, this.namespaceMap[item.name])) {
          item.num = this.namespaceMap[item.name].length
        } else {
          item.num = 0
        }
        return item
      })
    },
    change (v) {
      this.$emit('input', v)
      this.$emit('change', v)
      if (v) {
        const obj = this.options.find(val => val.name === v)
        this.$emit('update:namespaceObj', obj)
      } else {
        this.$emit('update:namespaceObj', {})
      }
    },
    _fetchNamespace () {
      const namespacesM = new this.$Manager('namespaces', 'v1')
      const params = {
        cluster: this.cluster,
        limit: 0,
        scope: this.$store.getters.scope,
      }
      if (!this.$store.getters.isAdminMode) {
        params.project = this.$store.getters.userInfo.projectId
      }
      if (!params.cluster) return
      namespacesM.list({ params }).then(({ data: { data = [] } }) => {
        this.options = data.map(val => ({ ...val, label: val.name }))
        /* 暂不支持 所有命名空间
          if (this.supportAllNamespace) {
            this.options = data.concat({ name: 'all_namespace', label: '所有命名空间' })
          } else {
            this.options = data.map(val => ({ ...val, label: val.name }))
          }
        */
        const isErrorNamespace = !this.options.find(v => v.name === this.value)
        if (this.setDefault && isErrorNamespace) {
          this.setDefaultNamespace(this.options)
        }
      })
    },
    setDefaultNamespace (opts) {
      const all = opts.find(v => v.name === 'all_namespace')
      if (opts && opts.length) {
        if (all) {
          this.namespace = all.name
        } else {
          this.namespace = opts[0].name
        }
        this.change(this.namespace)
      } else {
        this.change(undefined)
      }
    },
    filterOption (input, option) {
      return (
        option.componentOptions.children[0].text.toLowerCase().indexOf(input.toLowerCase()) >= 0
      )
    },
  },
}
</script>
